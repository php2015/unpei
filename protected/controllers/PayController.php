<?phpYii::import("mall.services.*");Yii::import("application.vendors.alipay.lib");class PayController extends Controller {    public function actionReturnfuc() {              $alipay = Yii::app()->alipay;        //验证成功,则进行业务逻辑处理        if ($alipay->verifyReturn()) {            $out_trade_no = $_GET['out_trade_no']; //商户订单号            $trade_no = $_GET['trade_no']; //支付宝交易号            $trade_status = $_GET['trade_status']; //交易状态            $order_id = $_GET['out_trade_no']; //订单编号            $total_fee = $_GET['total_fee']; //订单金额            if ($_GET['trade_status'] == 'TRADE_FINISHED' || $_GET['trade_status'] == 'TRADE_SUCCESS') {                //更新订单状态                //$result = RPCClient::call('OrderService_updateOrderStatus',array('order_no'=>$out_trade_no,'order_amount'=>$total_fee,                //		'pay_trade_no'=>$trade_no,'pay_trade_status'=>$trade_status));                echo "支付成功";                //$this->render('order_paid');            } else {                echo "trade_status=" . $_GET['trade_status'];            }            echo "验证成功<br />";        } else {            echo "验证失败";            Yii::app()->end();        }                   }    public function actionNotifyfuc() {        //数组格式        $alipay = Yii::app()->alipay;        //商户订单号        $order['OrderSN'] = $paypal['OrderSN'] = $_POST['out_trade_no'];        //支付宝交易号        $order['AlipayTN'] = $paypal['AlipayTN'] = $_POST['trade_no'];        //将传过来的数组进行序列化，用到的时候 直接反序列化        $paypal['Desc'] = serialize($order);        $paypal['ActionTime'] = time();        //交易状态        $paypal['Status'] = $_POST['trade_status'] ? $_POST['trade_status'] : $_POST['refund_status'];        //退货状态        if ($alipay->verifyNotify()) {            if ($_POST['trade_status']) {                if ($_POST['trade_status'] == 'WAIT_BUYER_PAY') {                    //该判断表示买家已在支付宝交易管理中产生了交易记录，但没有付款                    $order['Status'] = "1";                } else if ($_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {                    //该判断表示买家已在支付宝交易管理中产生了交易记录且付款成功，但卖家没有发货                    $order['Status'] = "2";                    $order["PayTime"] = time();                } else if ($_POST['trade_status'] == 'WAIT_BUYER_CONFIRM_GOODS') {                    //该判断表示卖家已经发了货，但买家还没有做确认收货的操作                    $order['Status'] = "3";                    $order["DeliveryTime"] = time();                } else if ($_POST['trade_status'] == 'TRADE_FINISHED') {                    //该判断表示买家已经确认收货，这笔交易完成                    $order['Status'] = "9";                    $order["ReceiptTime"] = time();                }            }elseif($_POST['refund_status']){                //已收到货的情况                if ($_POST['refund_status'] == 'WAIT_SELLER_AGREE') {                    //等待卖家同意退款                    $order['PayStatus'] = "WAIT_SELLER_AGREE";                } else if ($_POST['refund_status'] == 'WAIT_BUYER_RETURN_GOODS') {                    //卖家同意退款，等待买家退货                    $order['PayStatus'] = "WAIT_BUYER_RETURN_GOODS";                } else if ($_POST['refund_status'] == 'WAIT_SELLER_CONFIRM_GOODS') {                    //买家已退货，等待卖家收到退货                    $order['PayStatus'] = "WAIT_SELLER_CONFIRM_GOODS";                } else if ($_POST['refund_status'] == 'REFUND_SUCCESS') {                    //卖家收到退货，退款成功，交易关闭                    $order['Status'] = "10";                    $order['PayStatus'] = "REFUND_SUCCESS";                }                //未收到货的情况                if ($_POST['refund_status'] == 'WAIT_SELLER_AGREE') {                    //等待卖家同意退款                    $order['PayStatus'] = "WAIT_SELLER_AGREE";                }else if ($_POST['refund_status'] == 'REFUND_SUCCESS') {                    //卖家同意退款，退款成功，交易关闭                    $order['PayStatus'] = "REFUND_SUCCESS";                    $order['Status'] = "10";                }                            }            //交易流程            //执行更改订单状态操作            $response = JporderService::responseApplay($order);            if ($response) {                echo "success";            } else {                echo "failed";            }            //生成日志            JporderService::paylog($paypal);        } else {            echo "fail";            Yii::app()->end();        }    }}